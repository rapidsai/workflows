on:
  workflow_call:
    inputs:
      rapids_branch:
        description: "Branch to build/test (e.g. `main` or `release/25.12`)."
        required: true
        type: string
      repos:
        description: "Space-delimited list of repositories to build/test (e.g. `rapidsai/rmm rapidsai/cudf`)"
        required: true
        type: string
    outputs:
      obj:
        description: "A JSON object which includes the relevant information for a particular workflow run."
        value: ${{ jobs.run.outputs.obj }}

# The output object looks like this:
# {
#   "branch": "branch-25.10",
#   "ucxx-branch": "branch-0.46",
#   "payloads": {
#     "rmm": {
#       "branch": "branch-25.10",
#       "date": "2025-09-16",
#       "sha": "de85ed361daa9868df15f62aff257e0cef291843"
#     },
#     "cudf": {
#       "branch": "branch-25.10",
#       "date": "2025-09-16",
#       "sha": "fec23dd8cc35429a4e164ea95f13f2702a7daa91"
#     },
#     "ucxx": {
#       "branch": "branch-0.46",
#       "date": "2025-09-16",
#       "sha": "71a3af8bc473a0b87667d9a58af4476e9653ce20"
#     }
#   }
# }

defaults:
  run:
    shell: bash

jobs:
  run:
    runs-on: ubuntu-latest
    outputs:
      obj: ${{ steps.get-obj.outputs.obj }}
    env:
      GH_TOKEN: ${{secrets.WORKFLOW_TOKEN}}
    steps:
      - name: Get Run Info
        id: get-obj
        env:
          INPUTS_CONTEXT: ${{ toJson(inputs) }}
          RAPIDS_BRANCH: ${{ inputs.rapids_branch }}
          REPOS: ${{ inputs.repos }}
        run: |
          set -euo pipefail
          DATE=$(date +%F)
          export DATE

          # Extract RAPIDS version from branch name if it matches release/YY.MM pattern
          if [[ "${RAPIDS_BRANCH}" =~ ^release/([0-9]{2}\.[0-9]{2})$ ]]; then
            RAPIDS_VERSION="${BASH_REMATCH[1]}"
            # shellcheck disable=SC2086
            UCXX_VERSION="$(curl -sL https://version.gpuci.io/rapids/${RAPIDS_VERSION})"
            UCXX_BRANCH="release/${UCXX_VERSION}"
            export UCXX_BRANCH
          else
            # For non-release branches (e.g., main), use the same branch name for both
            UCXX_BRANCH="${RAPIDS_BRANCH}"
            export UCXX_BRANCH
          fi

          REPOS=$(echo "${REPOS}" | jq -Rc 'split(" ")')
          export REPOS

          PAYLOADS='{}'
          export PAYLOADS
          for REPO in $(jq -nr '(env.REPOS|fromjson) | .[]'); do
            JUST_REPO=${REPO##*/} # removes GH organization
            export JUST_REPO
            BRANCH="${RAPIDS_BRANCH}"
            export BRANCH

            if [ "${JUST_REPO}" = "ucxx" ]; then
              BRANCH="${UCXX_BRANCH}"
              export BRANCH
            fi

            SHA=$(gh api -q '.commit.sha' "repos/${REPO}/branches/${BRANCH}")
            export SHA

            # shellcheck disable=SC2034
            REPO_PAYLOAD=$(
              jq -nc '{
                "branch": env.BRANCH,
                "date": env.DATE,
                "sha": env.SHA
              }'
            )
            echo REPO_PAYLOAD
            PAYLOADS=$(jq -nc '(env.PAYLOADS|fromjson) + {(env.JUST_REPO): (env.REPO_PAYLOAD|fromjson)}')
          done

          OBJ=$(
            jq -nc '{
              "branch": env.RAPIDS_BRANCH,
              "ucxx-branch": env.UCXX_BRANCH,
              "payloads": (env.PAYLOADS|fromjson)
            }'
          )

          echo "OBJ=${OBJ}" | tee --append "${GITHUB_ENV}"
          echo "obj=${OBJ}" >> "${GITHUB_OUTPUT}"
      - name: Print Summary
        env:
          RAPIDS_BRANCH: ${{ inputs.rapids_branch }}
        run: |
          set -euo pipefail
          # shellcheck disable=SC2129
          echo "## \`${RAPIDS_BRANCH}\` Nightly Run" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Run parameters**:" >> "$GITHUB_STEP_SUMMARY"

          echo "\`\`\`json" >> "$GITHUB_STEP_SUMMARY"
          jq -n 'env.OBJ|fromjson' >> "$GITHUB_STEP_SUMMARY"
          echo "\`\`\`" >> "$GITHUB_STEP_SUMMARY"
