on:
  workflow_call:
    inputs:
      rapids_version:
        type: string
      repos:
        type: string
    outputs:
      obj:
        description: "A JSON object which includes the relevant information for a particular workflow run."
        value: ${{ jobs.run.outputs.obj }}

# The output object looks like this:
# {
#   "branch": "branch-25.10",
#   "ucxx-branch": "branch-0.46",
#   "payloads": {
#     "rmm": {
#       "branch": "branch-25.10",
#       "date": "2025-09-16",
#       "sha": "de85ed361daa9868df15f62aff257e0cef291843"
#     },
#     "cudf": {
#       "branch": "branch-25.10",
#       "date": "2025-09-16",
#       "sha": "fec23dd8cc35429a4e164ea95f13f2702a7daa91"
#     },
#     "ucxx": {
#       "branch": "branch-0.46",
#       "date": "2025-09-16",
#       "sha": "71a3af8bc473a0b87667d9a58af4476e9653ce20"
#     }
#   }
# }

defaults:
  run:
    shell: bash

jobs:
  run:
    runs-on: ubuntu-latest
    outputs:
      obj: ${{ steps.get-obj.outputs.obj }}
    env:
      GH_TOKEN: ${{secrets.WORKFLOW_TOKEN}}
    steps:
      - name: Get Run Info
        id: get-obj
        env:
          INPUTS_CONTEXT: ${{ toJson(inputs) }}
        run: |
          set -euo pipefail
          export DATE=$(date +%F)
          export RAPIDS_VERSION=${{ inputs.rapids_version }}
          export UCXX_VERSION="$(curl -sL https://version.gpuci.io/rapids/${RAPIDS_VERSION})"
          export RAPIDS_BRANCH="branch-${RAPIDS_VERSION}"
          export UCXX_BRANCH="branch-${UCXX_VERSION}"

          export REPOS=$(echo "${{ inputs.repos }}" | jq -Rc 'split(" ")')

          export PAYLOADS='{}'
          for REPO in $(jq -nr '(env.REPOS|fromjson) | .[]'); do
            export JUST_REPO=${REPO##*/} # removes GH organization
            export BRANCH="${RAPIDS_BRANCH}"

            if [ "${JUST_REPO}" = "ucxx" ]; then
              export BRANCH="${UCXX_BRANCH}"
            fi

            SHA=$(gh api -q '.commit.sha' "repos/${REPO}/branches/${BRANCH}")
            export SHA

            export REPO_PAYLOAD=$(
              jq -nc '{
                "branch": env.BRANCH,
                "date": env.DATE,
                "sha": env.SHA
              }'
            )
            PAYLOADS=$(jq -nc '(env.PAYLOADS|fromjson) + {(env.JUST_REPO): (env.REPO_PAYLOAD|fromjson)}')
          done

          OBJ=$(
            jq -nc '{
              "branch": env.RAPIDS_BRANCH,
              "ucxx-branch": env.UCXX_BRANCH,
              "payloads": (env.PAYLOADS|fromjson)
            }'
          )

          echo "OBJ=${OBJ}" | tee --append "${GITHUB_ENV}"
          echo "obj=${OBJ}" >> "${GITHUB_OUTPUT}"
      - name: Print Summary
        env:
          RAPIDS_VERSION: ${{ inputs.rapids_version }}
          RUN_TESTS: ${{ inputs.run_tests }}
        run: |
          set -euo pipefail
          echo "## \`${RAPIDS_VERSION}\` Nightly Run" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Run tests**: \`${RUN_TESTS}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "**Run parameters**:" >> "$GITHUB_STEP_SUMMARY"

          echo "\`\`\`json" >> "$GITHUB_STEP_SUMMARY"
          echo "$(jq -n 'env.OBJ|fromjson')" >> "$GITHUB_STEP_SUMMARY"
          echo "\`\`\`" >> "$GITHUB_STEP_SUMMARY"
